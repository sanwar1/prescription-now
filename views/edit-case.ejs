<!DOCTYPE html>
<html>
    <%- include('./partials/header'); %>
    <!-- <body class="bg-light" onload="setPrescriptionDate()"> -->
    <body class="bg-light">
        <%- include('./partials/nav'); %>

        <div class="container max-width: 800px;">
            <!-- Logo and Header -->
            <div class="row justify-content-center">
                <div class="col-auto">
                    <br />
                    <i
                        class="bi bi-prescription text-success"
                        style="font-size: 100px"
                    ></i>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-auto"><p class="fs-2 text">New Case</p></div>
            </div>
            <br />
            <form action="/cases/<%=data.casefile._id%>/edit" method="POST">
                <div class="row">
                    <div class="col">
                        <p class="fs-4 text">Patient Details</p>
                    </div>
                </div>
                <!-- Patient ID: Hidden input -->
                <input
                    type="hidden"
                    name="patientID"
                    class="form-control"
                    required
                    value="<%= data.patient._id%>"
                />
                <!-- Patient Details -->
                <div class="row">
                    <div class="col">
                        <label for="date" class="form-label"
                            >PrescriptionDate:</label
                        >
                        <input
                            type="date"
                            name="date"
                            class="form-control"
                            id="prescriptionDate"
                            value="<%= data.casefile.prescriptionDate%>"
                            required
                        /><br />
                    </div>
                    <div class="col">
                        <label for="firstName" class="form-label">First Name:</label>
                        <input
                            type="text"
                            name="firstName"
                            class="form-control"
                            value="<%= data.patient.firstName %>"
                            readonly
                            required
                        /><br />
                    </div>
                    <div class="col">
                        <label for="lastName" class="form-label"
                            >Last Name:</label
                        >
                        <input
                            type="text"
                            name="lastName"
                            class="form-control"
                            value="<%= data.patient.lastName %>"
                            readonly
                            required
                        /><br />
                    </div>
                    <div class="col">
                        <label for="age" class="form-label">Age:</label>
                        <input
                            type="number"
                            name="age"
                            class="form-control"
                            value="<%= new Date().getFullYear() - data.patient.dateOfBirth.getFullYear() %>"
                            readonly
                            required
                        /><br />
                    </div>
                    <div class="col">
                        <label for="gender" class="form-label">Gender:</label>
                        <select
                            name="gender"
                            class="form-control"
                            value="<%= data.patient.gender %>"
                            required
                            style="pointer-events: none"
                            onclick="return false;"
                            onkeydown="return false;"
                        >
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Other</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label for="phone" class="form-label"
                            >Phone Number:</label
                        >
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            class="form-control"
                            pattern="[0-9]{10}"
                            value="<%= data.patient.phoneNumber %>"
                            readonly
                        />
                    </div>
                    <div class="col">
                        <label for="email" class="form-label">Email:</label>
                        <input
                            type="email"
                            name="email"
                            class="form-control"
                            value="<%= data.patient.email %>"
                            readonly
                            required
                        />
                    </div>
                </div>
                <br />
                <!-- Chief Complaint -->
                <div class="row">
                    <div class="col">
                        <label for="chiefComplaint" class="form-label">Patient Complaint:</label>
                        <textarea
                            name="chiefComplaint"
                            rows="4"
                            cols="50"
                            class="form-control"
                            required
                        ><%= data.casefile.chiefComplaint %></textarea>
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col">
                        <label for="symptomsHistory" class="form-label"
                            >Symptoms / History:</label>
                        <textarea
                            name="symptomsHistory"
                            rows="4"
                            cols="50"
                            class="form-control"
                            required
                        ><%= data.casefile.symptomsHistory %></textarea>
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col">
                        <label for="recommendations" class="form-label">Recommendations:</label>
                        <textarea
                            name="recommendations"
                            rows="4"
                            cols="50"
                            class="form-control"
                            required><%= data.casefile.recommendations %></textarea>
                    </div>
                </div>
                <br />
                <!-- Medications -->
                <div class="row">
                    <div class="col">
                        <p class="fs-4 text">Medications</p>
                    </div>
                </div>

                <div class="container" id="prescriptionContainer">
                    <div class="row">
                        <div class="col-6">
                            <p class="fs-6 text">Medicine</p>
                        </div>
                        <div class="col-3">
                            <p class="fs-6 text">Dosage</p>
                        </div>
                        <div class="col-3">
                            <p class="fs-6 text">Duration (in days)</p>
                        </div>
                    </div>
                    <!-- DEBUG -->
                    <!-- <div></div> -->
                    <% for(var i=0; i<data.casefile.prescription.length; i++){ %>
                        <div class="row">
                            <div class="col-6" id="medicine">
                                <input type="text" name="medicine[]" class="form-control" value="<%=data.casefile.prescription[i].medicine%>" required/>
                            </div>
                            <div class="col-3" id="dosage">
                                <select
                                    name="dosage[]"
                                    class="form-control"
                                    required
                                    value="Twice a Day"
                                >
                                    <% if(data.casefile.prescription[i].dosage == 'Once a Day'){
                                        %>
                                            <option value="Once a Day" selected>Once a Day</option>
                                            <option value="Twice a Day">Twice a Day</option>
                                            <option value="Three times a Day">Three times a Day</option>
                                            <option value="SOS">SOS</option>
                                    <% }
                                        if(data.casefile.prescription[i].dosage == 'Twice a Day'){ %>
                                            <option value="Once a Day" >Once a Day</option>
                                            <option value="Twice a Day" selected>Twice a Day</option>
                                            <option value="Three times a Day">Three times a Day</option>
                                            <option value="SOS">SOS</option>
                                    <% }
                                        if(data.casefile.prescription[i].dosage == 'Three times a Day'){ %>
                                            <option value="Once a Day" >Once a Day</option>
                                            <option value="Twice a Day" >Twice a Day</option>
                                            <option value="Three times a Day" selected>Three times a Day</option>
                                            <option value="SOS">SOS</option>
                                    <% }
                                        if(data.casefile.prescription[i].dosage == 'SOS'){ %>
                                        <option value="Once a Day" >Once a Day</option>
                                        <option value="Twice a Day" >Twice a Day</option>
                                        <option value="Three times a Day" >Three times a Day</option>
                                        <option value="SOS" selected>SOS</option>
                                    <%
                                       }
                                    %>
                                </select>
                                <br />
                            </div>
                            <div class="col-3" id="duration">
                                <input
                                    type="number"
                                    name="duration[]"
                                    class="form-control"
                                    min="0"
                                    max="90"
                                    value="<%=data.casefile.prescription[i].duration%>"
                                    required
                                /><br />
                            </div>
                        </div>
                    <% } %>
                </div>

                <div class="row">
                    <div class="col">
                        <button
                            type="button"
                            onclick="addPrescriptionRow()"
                            class="btn btn-secondary"
                        >
                            Add Medicines</button
                        ><br /><br />
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <p class="fs-4 text">Diagnostics</p>
                    </div>
                </div>

                <div id="diagnosticTestsContainer">
                    <% for(var i=0; i<data.casefile.diagnosticTests.length; i++) {%>
                        <input
                        type="text"
                        name="diagnosticTests[]"
                        class="form-control"
                        value="<%=data.casefile.diagnosticTests[i]%>"
                        required
                        /><br />
                    <% } %>
                </div>
                <div class="row">
                    <div class="col">
                        <button
                            type="button"
                            onclick="addDiagnosticTest()"
                            class="btn btn-secondary"
                        >
                            Add Tests
                        </button>
                        <br /><br />
                    </div>
                </div>

                <input
                    type="submit"
                    value="Save to Database"
                    class="btn btn-primary"
                />
            </form>
        </div>
        <!-- Footer -->
        <%- include('./partials/footer'); %>

        <script>
            // JavaScript functions to add new rows for prescription and diagnostic tests
            function addPrescriptionRow() {
                const container = document.getElementById(
                    "prescriptionContainer"
                );
                // Creating a row
                const row = document.createElement("div");
                row.className = "row ";
                container.appendChild(row);

                // Creating a col1
                const col1 = document.createElement("div");
                col1.className = "col-6 ";
                row.appendChild(col1);
                // Creating an input in first column
                const medicine = document.createElement("input");
                medicine.className = "form-control";
                medicine.type = "text";
                medicine.name = "medicine[]";
                medicine.required = true;
                col1.appendChild(medicine);

                // Creating a col2
                const col2 = document.createElement("div");
                col2.className = "col-3 ";
                row.appendChild(col2);
                // Creating a select in the second column
                var dosage = document.createElement("select");
                dosage.id = "mySelect";
                dosage.className = "form-control";
                dosage.name = "dosage[]";
                dosage.required = true;
                col2.appendChild(dosage);
                // Adding options in the select field
                var value = ["OD", "BD", "TD", "SOS"];
                var text = [
                    "Once a Day",
                    "Twice a Day",
                    "Three times a Day",
                    "SOS",
                ];
                for (var i = 0; i < value.length; i++) {
                    var option = document.createElement("option");
                    option.value = value[i];
                    option.text = text[i];
                    dosage.appendChild(option);
                }

                // Creating a col3
                const col3 = document.createElement("div");
                col3.className = "col-3 ";
                row.appendChild(col3);
                // Creating an input in the third column
                const duration = document.createElement("input");
                duration.className = "form-control";
                duration.type = "number";
                duration.name = "duration[]";
                duration.min = 0;
                duration.max = 90;
                col3.appendChild(duration);
                col3.appendChild(document.createElement("br"));
                // col3.appendChild(document.createElement("br"));
            }

            function addDiagnosticTest() {
                const container = document.getElementById(
                    "diagnosticTestsContainer"
                );
                const input = document.createElement("input");
                input.className = "form-control";
                input.type = "text";
                input.name = "diagnosticTests[]";
                input.required = true;
                container.appendChild(input);
                container.appendChild(document.createElement("br"));
            }

            // let year = data.casefile.prescriptionDate.getYear().toString();
            // let month = data.casefile.prescriptionDate.getMonth().toString();
            // let date = data.casefile.prescriptionDate.getDate().toString();
            // let dateString = year + "-" + month + "-" + date
            // console.log("Date String: " + dateString)

            // document.getElementById("prescriptionDate").defaultValue = dateString;

            // function setPrescriptionDate() {
            //     // console.log(data.casefile.prescriptionDate)
            //     document.getElementById("prescriptionDate").defaultValue = "2014-02-09";
            // }
        </script>
        <!-- Boot Strap Scripts -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"
        ></script>
    </body>
</html>
